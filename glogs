#!/bin/bash
# uses goaccess to summarize nginx logs
# glogs html is run every hour with:
# 0 */1 * * * /home/sean/vps/glogs html

# once a user is in /etc/nginx/blacklist.conf
# dont show it in the glogs file
cd /var/log/nginx

function generate_blacklist_regex() {
	# a | separated list of IPs to filter from logs
	# each item starts with ^, so that the IP matches
	# the beginning of the line
	EGREP_FILTER_LIST=""
	while IFS= read -r line; do
		# get the banned IP
		ip=$(awk '{print $2}' <<<"$line" | tr -d ';')
		EGREP_FILTER_LIST="${EGREP_FILTER_LIST}^${ip} |"
	done <"/etc/nginx/blacklist.conf"
	EGREP_FILTER_LIST="${EGREP_FILTER_LIST::-1}"
	echo "$EGREP_FILTER_LIST"
}

function filter_banned_users() {
	# remove banned users from access logs
	grep -v -E "$(generate_blacklist_regex)"
}

case "$1" in
raw)
	# just print the logs
	# sort from: https://rstefan.blogspot.com/2014/01/how-to-merge-and-sort-by-date-nginx.html
	{
		zcat access.log.*.gz
		cat access.log
	} | sort -t ' ' -k 4.9,4.12n -k 4.5,4.7M -k 4.2,4.3n -k 4.14,4.15n -k 4.17,4.18n -k 4.20,4.21n
	;;
recent)
	# goaccess terminal recent logs
	tail -f -n +1 access.log | filter_banned_users | goaccess --log-format=COMBINED -
	;;
all)
	# goaccess terminal all logs
	{ zcat access.log.*.gz && tail -f -n +1 access.log; } | filter_banned_users | goaccess --log-format=COMBINED -
	;;
html)
	# generate goaccess html report for all logs
	{ zcat access.log.*.gz && cat access.log; } | filter_banned_users | goaccess --log-format=COMBINED -o "${HOME}/.goaccess_html/index.html" -
	echo
	# ./banned.html includes banned users
	{ zcat access.log.*.gz && cat access.log; } | goaccess --log-format=COMBINED -o "${HOME}/.goaccess_html/banned.html" -
	echo
	# add link from main page to banned page
	sed -i -e "s|Dashboard</span>|Dashboard</span><span style=\"font-size: 50%; margin-left: 20px; letter-spacing: 0.2px\"><a href=\"./banned.html\">banned users</a></span>|" "${HOME}/.goaccess_html/index.html"
	;;
*)
	echo "Must specify 'recent', 'all', 'raw', or 'html' as argument"
	exit 1
	;;
esac
